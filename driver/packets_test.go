package driver

import (
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestHandleERRPacket(t *testing.T) {

	mc := MySQLConnector{}
	input := []byte{0xff, 0x15, 0x04, 0x23, 0x32, 0x38, 0x30, 0x30, 0x30, 0x41, 0x63, 0x63, 0x65, 0x73, 0x73, 0x20, 0x64, 0x65, 0x6e, 0x69, 0x65, 0x64, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x75, 0x73, 0x65, 0x72, 0x20, 0x27, 0x72, 0x65, 0x70, 0x6c, 0x27, 0x40, 0x27, 0x31, 0x32, 0x31, 0x2e, 0x31, 0x32, 0x31, 0x2e, 0x30, 0x2e, 0x36, 0x34, 0x27, 0x20, 0x28, 0x75, 0x73, 0x69, 0x6e, 0x67, 0x20, 0x70, 0x61, 0x73, 0x73, 0x77, 0x6f, 0x72, 0x64, 0x3a, 0x20, 0x59, 0x45, 0x53, 0x29}
	want := "ErrorPacket [errorCode=1045, message=Access denied for user 'repl'@'121.121.0.64' (using password: YES), sqlState=28000]"
	out := mc.handleERRPacket(input).Error()
	assert.Equal(t, want, out)

	input1 := []byte{0xff, 0x48, 0x04, 0x23, 0x48, 0x59, 0x30, 0x30, 0x30, 0x4e, 0x6f, 0x20, 0x74, 0x61, 0x62, 0x6c, 0x65, 0x73, 0x20, 0x75, 0x73, 0x65, 0x64}
	want1 := "ErrorPacket [errorCode=1096, message=No tables used, sqlState=HY000]"
	out1 := mc.handleERRPacket(input1).Error()

	assert.Equal(t, want1, out1)
}
